<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لوحة متصدري نادي القراءة</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBnxRWZ25gjskld4JQthZInxCUNeFGHNes",
  authDomain: "book-club-6c164.firebaseapp.com",
  projectId: "book-club-6c164",
  storageBucket: "book-club-6c164.firebasestorage.app",
  messagingSenderId: "903267722786",
  appId: "1:903267722786:web:ab556bff593722d56e0c7b",
  measurementId: "G-H4CS2ZDN1L"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
    
    // Initialize Firebase and Firestore
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Global variables for user and UI elements
    let currentUser = null;
    let unsubscribeLeaderboard = null;
    
    // UI elements
    const userIdDisplay = document.getElementById('userIdDisplay');
    const nameInput = document.getElementById('nameInput');
    const progressInput = document.getElementById('progressInput');
    const saveButton = document.getElementById('saveButton');
    const leaderboardList = document.getElementById('leaderboardList');
    const noUsersMessage = document.getElementById('noUsersMessage');

    // Authentication and data setup
    async function setupApp() {
      try {
        await signInAnonymously(auth);
        currentUser = auth.currentUser;
        userIdDisplay.textContent = currentUser.uid;
        
        // Disable save button while loading
        saveButton.disabled = false;
        
        // Start listening to the leaderboard
        startLeaderboardListener();
      } catch (error) {
        console.error("Firebase Auth Error: ", error);
        // Fallback or error message on UI
        userIdDisplay.textContent = 'خطأ في تسجيل الدخول';
      }
    }

    // Function to start the real-time leaderboard listener
    function startLeaderboardListener() {
      const leaderboardRef = collection(db, `users`);
      
      unsubscribeLeaderboard = onSnapshot(leaderboardRef, (snapshot) => {
        const users = [];
        snapshot.forEach(doc => {
          users.push({ id: doc.id, ...doc.data() });
        });
        
        // Sort users by progress in descending order in memory
        users.sort((a, b) => b.progress - a.progress);
        
        displayLeaderboard(users);
      }, (error) => {
        console.error("Firestore Error: ", error);
      });
    }

    // Function to display the leaderboard data on the page
    function displayLeaderboard(users) {
      leaderboardList.innerHTML = ''; // Clear previous list
      if (users.length === 0) {
        noUsersMessage.classList.remove('hidden');
        return;
      }
      noUsersMessage.classList.add('hidden');
      
      users.forEach((user, index) => {
        const isCurrentUser = currentUser && user.id === currentUser.uid;
        const userElement = `
          <div class="grid grid-cols-3 gap-4 items-center py-3 border-b border-gray-200 last:border-b-0 transition-colors duration-200 ${isCurrentUser ? 'bg-blue-50 rounded-lg p-2' : ''}">
            <div class="font-bold text-lg text-gray-800">${index + 1}</div>
            <div class="flex flex-col">
              <span class="font-medium text-gray-700">${user.name}</span>
              <span class="text-xs text-gray-400 truncate mt-1 break-all">${user.id}</span>
            </div>
            <div class="font-bold text-lg text-right text-blue-600">${user.progress}</div>
          </div>
        `;
        leaderboardList.innerHTML += userElement;
      });
    }

    // Function to handle saving user data
    async function handleSave(event) {
      event.preventDefault();
      if (!currentUser) {
        console.error("User not authenticated.");
        return;
      }
      
      const name = nameInput.value.trim();
      const progress = parseInt(progressInput.value, 10);
      
      if (!name || isNaN(progress)) {
        alert("الرجاء إدخال اسمك وعدد الصفحات بشكل صحيح!");
        return;
      }

      const userDocRef = doc(db, `users/${currentUser.uid}`);
      
      try {
        await setDoc(userDocRef, {
          name: name,
          progress: progress,
          lastUpdated: new Date().toISOString()
        }, { merge: true });
        
        console.log('User data saved successfully!');
      } catch (error) {
        console.error('Error saving user data:', error);
      }
    }

    // Add event listener to the save button
    window.onload = () => {
      saveButton.addEventListener('click', handleSave);
      setupApp();
    };

  </script>
  <style>
    /* Custom styles for a better look on mobile */
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');
    body {
        font-family: 'Tajawal', sans-serif;
    }
  </style>
</head>
<body class="min-h-screen bg-gray-100 p-4 font-sans antialiased flex flex-col items-center">
  <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-2xl text-center">
    <h1 class="text-4xl font-bold text-gray-800 mb-2">لوحة متصدري نادي القراءة</h1>
    <p class="text-gray-500 mb-6">منو راح يوصل لنهاية الكتاب أول؟ 🤔</p>
    <p class="text-sm text-gray-600 mb-4">
      أنت حاليًا المستخدم: <span id="userIdDisplay" class="font-mono bg-gray-200 px-2 py-1 rounded-md text-gray-800 break-all">جارِ التحميل...</span>
    </p>

    <!-- User Input Form -->
    <form class="flex flex-col md:flex-row items-center justify-center gap-4 mb-8" onsubmit="handleSave()">
      <input
        id="nameInput"
        type="text"
        placeholder="اكتب اسمك"
        class="w-full p-3 text-lg border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-300"
      />
      <input
        id="progressInput"
        type="number"
        placeholder="عدد الصفحات"
        class="w-full p-3 text-lg border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-300"
      />
      <button
        id="saveButton"
        type="submit"
        disabled
        class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white p-3 rounded-lg shadow-md hover:from-blue-600 hover:to-blue-700 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed font-semibold"
      >
        تحديث التقدم
      </button>
    </form>

    <!-- Leaderboard Table -->
    <div class="w-full text-left">
      <div class="grid grid-cols-3 gap-4 font-bold text-gray-700 border-b-2 border-gray-300 pb-2 mb-4">
        <div>المرتبة</div>
        <div>الاسم</div>
        <div class="text-right">عدد الصفحات</div>
      </div>
      <p id="noUsersMessage" class="text-gray-500 text-center py-4 hidden">لا يوجد أي مشارك حتى الآن. كن أول من ينضم!</p>
      <div id="leaderboardList">
        <!-- Leaderboard items will be rendered here by JavaScript -->
      </div>
    </div>
  </div>
</body>
</html>
